     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fscanf
     4                                  
     5                                  extern COMPLEXNUMBER
     6                                  extern FRACTION
     7                                  extern COORDINATES
     8                                  
     9                                  ;----------------------------------------------
    10                                  ; // Ввод параметров комплексного числа из файла
    11                                  ; void InCompexNumber(void *r, FILE *ifst) {
    12                                  ;     fscanf(ifst, "%d%d", (int*)r, (int*)(r+intSize));
    13                                  ; }
    14                                  global InComplexNumber
    15                                  InComplexNumber:
    16                                  section .data
    17 00000000 2564256400                  .infmt db "%d%d",0
    18                                  section .bss
    19 00000000 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    20 00000008 <res 00000008>              .pcomp  resq    1   ; адрес прямоугольника
    21                                  section .text
    22 00000000 55                      push rbp
    23 00000001 4889E5                  mov rbp, rsp
    24                                  
    25                                      ; Сохранение принятых аргументов
    26 00000004 48893C25[08000000]          mov     [.pcomp], rdi          ; сохраняется адрес прямоугольника
    27 0000000C 48893425[00000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    28                                  
    29                                      ; Ввод прямоугольника из файла
    30 00000014 488B3C25[00000000]          mov     rdi, [.FILE]
    31 0000001C 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    31 0000001E [0000000000000000] 
    32 00000026 488B1425[08000000]          mov     rdx, [.pcomp]       ; &x
    33 0000002E 488B0C25[08000000]          mov     rcx, [.pcomp]
    34 00000036 4883C104                    add     rcx, 4              ; &y = &x + 4
    35 0000003A B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    36 0000003F E8(00000000)                call    fscanf
    37                                  
    38 00000044 C9                      leave
    39 00000045 C3                      ret
    40                                  
    41                                  ; // Ввод параметров треугольника из файла
    42                                  ; void InTriangle(void *t, FILE *ifst) {
    43                                  ;     fscanf(ifst, "%d%d%d", (int*)t,
    44                                  ;            (int*)(t+intSize), (int*)(t+2*intSize));
    45                                  ; }
    46                                  global InFraction
    47                                  InFraction:
    48                                  section .data
    49 00000005 2564256400                  .infmt db "%d%d",0
    50                                  section .bss
    51 00000010 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    52 00000018 <res 00000008>              .pfrac  resq    1   ; адрес прямоугольника
    53                                  section .text
    54 00000046 55                      push rbp
    55 00000047 4889E5                  mov rbp, rsp
    56                                  
    57                                      ; Сохранение принятых аргументов
    58 0000004A 48893C25[18000000]          mov     [.pfrac], rdi          ; сохраняется адрес прямоугольника
    59 00000052 48893425[10000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    60                                  
    61                                      ; Ввод прямоугольника из файла
    62 0000005A 488B3C25[10000000]          mov     rdi, [.FILE]
    63 00000062 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    63 00000064 [0500000000000000] 
    64 0000006C 488B1425[18000000]          mov     rdx, [.pfrac]       ; &x
    65 00000074 488B0C25[18000000]          mov     rcx, [.pfrac]
    66 0000007C 4883C104                    add     rcx, 4              ; &y = &x + 4
    67 00000080 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    68 00000085 E8(00000000)                call    fscanf
    69                                  
    70 0000008A 4883F900                    cmp rcx, 0
    71 0000008E 7402                        je arequal
    72 00000090 EB05                        jmp return
    73                                  
    74                                      arequal:
    75 00000092 B901000000                  mov rcx, 1
    76                                      return:
    77                                  
    78 00000097 C9                      leave
    79 00000098 C3                      ret
    80                                  
    81                                  
    82                                  global InCoordinates
    83                                  InCoordinates:
    84                                  section .data
    85 0000000A 2564256400                  .infmt db "%d%d",0
    86                                  section .bss
    87 00000020 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    88 00000028 <res 00000008>              .pcoord  resq    1   ; адрес прямоугольника
    89                                  section .text
    90 00000099 55                      push rbp
    91 0000009A 4889E5                  mov rbp, rsp
    92                                  
    93                                      ; Сохранение принятых аргументов
    94 0000009D 48893C25[28000000]          mov     [.pcoord], rdi          ; сохраняется адрес прямоугольника
    95 000000A5 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    96                                  
    97                                      ; Ввод прямоугольника из файла
    98 000000AD 488B3C25[20000000]          mov     rdi, [.FILE]
    99 000000B5 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    99 000000B7 [0A00000000000000] 
   100 000000BF 488B1425[28000000]          mov     rdx, [.pcoord]       ; &x
   101 000000C7 488B0C25[28000000]          mov     rcx, [.pcoord]
   102 000000CF 4883C104                    add     rcx, 4              ; &y = &x + 4
   103 000000D3 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
   104 000000D8 E8(00000000)                call    fscanf
   105 000000DD C9                      leave
   106 000000DE C3                      ret
   107                                  
   108                                  ; // Ввод параметров обобщенной фигуры из файла
   109                                  ; int InShape(void *s, FILE *ifst) {
   110                                  ;     int k;
   111                                  ;     fscanf(ifst, "%d", &k);
   112                                  ;     switch(k) {
   113                                  ;         case 1:
   114                                  ;             *((int*)s) = RECTANGLE;
   115                                  ;             InRectangle(s+intSize, ifst);
   116                                  ;             return 1;
   117                                  ;         case 2:
   118                                  ;             *((int*)s) = TRIANGLE;
   119                                  ;             InTriangle(s+intSize, ifst);
   120                                  ;             return 1;
   121                                  ;         default:
   122                                  ;             return 0;
   123                                  ;     }
   124                                  ; }
   125                                  global InNumber
   126                                  InNumber:
   127                                  section .data
   128 0000000F 256400                      .tagFormat   db      "%d",0
   129 00000012 5461672069733A2025-         .tagOutFmt   db     "Tag is: %d",10,0
   129 0000001B 640A00             
   130                                  section .bss
   131 00000030 <res 00000008>              .FILE       resq    1   ; временное хранение указателя на файл
   132 00000038 <res 00000008>              .pnum     resq    1   ; адрес фигуры
   133 00000040 <res 00000004>              .shapeTag   resd    1   ; признак фигуры
   134                                  section .text
   135 000000DF 55                      push rbp
   136 000000E0 4889E5                  mov rbp, rsp
   137                                  
   138                                      ; Сохранение принятых аргументов
   139 000000E3 48893C25[38000000]          mov     [.pnum], rdi          ; сохраняется адрес фигуры
   140 000000EB 48893425[30000000]          mov     [.FILE], rsi            ; сохраняется указатель на файл
   141                                  
   142                                      ; чтение признака фигуры и его обработка
   143 000000F3 488B3C25[30000000]          mov     rdi, [.FILE]
   144 000000FB 48BE-                       mov     rsi, .tagFormat
   144 000000FD [0F00000000000000] 
   145 00000105 488B1425[38000000]          mov     rdx, [.pnum]      ; адрес начала фигуры (ее признак)
   146 0000010D 4831C0                      xor     rax, rax            ; нет чисел с плавающей точкой
   147 00000110 E8(00000000)                call    fscanf
   148                                  
   149                                      ; Тестовый вывод признака фигуры
   150                                  ;     mov     rdi, .tagOutFmt
   151                                  ;     mov     rax, [.pshape]
   152                                  ;     mov     esi, [rax]
   153                                  ;     call    printf
   154                                  
   155 00000115 488B0C25[38000000]          mov rcx, [.pnum]          ; загрузка адреса начала фигуры
   156 0000011D 8B01                        mov eax, [rcx]              ; и получение прочитанного признака
   157 0000011F 3B0425[00000000]            cmp eax, [COMPLEXNUMBER]
   158 00000126 7416                        je .compIn
   159 00000128 3B0425[00000000]            cmp eax, [FRACTION]
   160 0000012F 742D                        je .fracIn
   161 00000131 3B0425[00000000]            cmp eax, [COORDINATES]
   162 00000138 7444                        je .coordIn
   163 0000013A 31C0                        xor eax, eax    ; Некорректный признак - обнуление кода возврата
   164 0000013C EB60                        jmp     .return
   165                                  .compIn:
   166                                      ; Ввод прямоугольника
   167 0000013E 488B3C25[38000000]          mov     rdi, [.pnum]
   168 00000146 4883C704                    add     rdi, 4
   169 0000014A 488B3425[30000000]          mov     rsi, [.FILE]
   170 00000152 E8A9FEFFFF                  call    InComplexNumber
   171 00000157 B801000000                  mov     rax, 1  ; Код возврата - true
   172 0000015C EB40                        jmp     .return
   173                                  .fracIn:
   174                                      ; Ввод треугольника
   175 0000015E 488B3C25[38000000]          mov     rdi, [.pnum]
   176 00000166 4883C704                    add     rdi, 4
   177 0000016A 488B3425[30000000]          mov     rsi, [.FILE]
   178                                  
   179 00000172 E8CFFEFFFF                  call    InFraction
   180 00000177 B801000000                  mov     rax, 1  ; Код возврата - true
   181 0000017C EB20                        jmp     .return
   182                                  .coordIn:
   183                                      ; Ввод треугольника
   184 0000017E 488B3C25[38000000]          mov     rdi, [.pnum]
   185 00000186 4883C704                    add     rdi, 4
   186 0000018A 488B3425[30000000]          mov     rsi, [.FILE]
   187 00000192 E802FFFFFF                  call    InCoordinates
   188 00000197 B801000000                  mov     rax, 1  ; Код возврата - true
   189 0000019C EB00                        jmp     .return
   190                                  .return:
   191                                  
   192 0000019E C9                      leave
   193 0000019F C3                      ret
   194                                  
   195                                  ; // Ввод содержимого контейнера из указанного файла
   196                                  ; void InContainer(void *c, int *len, FILE *ifst) {
   197                                  ;     void *tmp = c;
   198                                  ;     while(!feof(ifst)) {
   199                                  ;         if(InShape(tmp, ifst)) {
   200                                  ;             tmp = tmp + shapeSize;
   201                                  ;             (*len)++;
   202                                  ;         }
   203                                  ;     }
   204                                  ; }
   205                                  global InContainer
   206                                  InContainer:
   207                                  section .bss
   208 00000044 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   209 0000004C <res 00000008>              .plen   resq    1   ; адрес для сохранения числа введенных элементов
   210 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   211                                  section .text
   212 000001A0 55                      push rbp
   213 000001A1 4889E5                  mov rbp, rsp
   214                                  
   215 000001A4 48893C25[44000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   216 000001AC 48893425[4C000000]          mov [.plen], rsi    ; сохраняется указатель на длину
   217 000001B4 48891425[54000000]          mov [.FILE], rdx    ; сохраняется указатель на файл
   218                                      ; В rdi адрес начала контейнера
   219 000001BC 4831DB                      xor rbx, rbx        ; число фигур = 0
   220 000001BF 4889D6                      mov rsi, rdx        ; перенос указателя на файл
   221                                  .loop:
   222                                      ; сохранение рабочих регистров
   223 000001C2 57                          push rdi
   224 000001C3 53                          push rbx
   225                                  
   226 000001C4 488B3425[54000000]          mov     rsi, [.FILE]
   227 000001CC B800000000                  mov     rax, 0      ; нет чисел с плавающей точкой
   228 000001D1 E809FFFFFF                  call    InNumber     ; ввод фигуры
   229 000001D6 4883F800                    cmp rax, 0          ; проверка успешности ввода
   230 000001DA 7E0B                        jle  .return        ; выход, если признак меньше или равен 0
   231                                  
   232 000001DC 5B                          pop rbx
   233 000001DD 48FFC3                      inc rbx
   234                                  
   235 000001E0 5F                          pop rdi
   236 000001E1 4883C710                    add rdi, 16             ; адрес следующей фигуры
   237                                  
   238 000001E5 EBDB                        jmp .loop
   239                                  .return:
   240 000001E7 488B0425[4C000000]          mov rax, [.plen]    ; перенос указателя на длину
   241 000001EF 8918                        mov [rax], ebx      ; занесение длины
   242 000001F1 C9                      leave
   243 000001F2 C3                      ret
   244                                  
