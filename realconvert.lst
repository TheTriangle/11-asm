     1                                  ;------------------------------------------------------------------------------
     2                                  ; perimeter.asm - единица компиляции, вбирающая функции вычисления периметра
     3                                  ;------------------------------------------------------------------------------
     4                                  %include "printmacros.mac"
     1                              <1> extern  fprintf
     2                              <1> extern  OutContainer
     3                              <1> 
     4                              <1> ;-------------------------------------------------------------
     5                              <1> ; Вывод строки, передаваемой непосредственно макросу
     6                              <1> ; с переводом на следующую строку
     7                              <1> %macro  PrintStr2    2
     8                              <1>     section .data
     9                              <1>         %%arg1  db  %1,10,0     ; first argument
    10                              <1>     section .text               ; the printf arguments
    11                              <1>         push rdi
    12                              <1>         push rsi
    13                              <1>         push rax
    14                              <1>         mov rdi, %2
    15                              <1>         mov rsi, %%arg1
    16                              <1>         mov rax, 0              ; no floating point
    17                              <1>         call fprintf
    18                              <1>         pop rdi
    19                              <1>         pop rsi
    20                              <1>         pop rax
    21                              <1> %endmacro
    22                              <1> 
    23                              <1> ; Вывод содержимого контейнера
    24                              <1> %macro  PrintContainer2    3
    25                              <1>     mov     rdi, %1
    26                              <1>     mov     esi, %2
    27                              <1>     mov     rdx, %3
    28                              <1>     mov     rax, 0              ; нет чисел с плавающей точкой
    29                              <1>     call    OutContainer
    30                              <1> %endmacro
    31                              <1> 
    32                              <1> %macro  PrintInt2    2
    33                              <1>     section .data
    34                              <1>         %%arg1  db  "%d ",10,0     ; first argument
    35                              <1>     section .text               ; the printf arguments
    36                              <1>         mov rdi, %2
    37                              <1>         mov rsi, %%arg1
    38                              <1>         mov rdx, %1
    39                              <1>         mov rax, 0              ; no floating point
    40                              <1>         call fprintf
    41                              <1> %endmacro
    42                              <1> 
    43                              <1> %macro  PrintDouble2    2
    44                              <1>     section .data
    45                              <1>         %%arg1  db  "%g",0     ; first argument
    46                              <1>     section .text               ; the printf arguments
    47                              <1>         mov rdi, %2
    48                              <1>         mov rsi, %%arg1
    49                              <1>         movsd xmm0, %1
    50                              <1>         mov rax, 1              ; no floating point
    51                              <1>         call fprintf
    52                              <1> %endmacro
     5                                  extern COMPLEXNUMBER
     6                                  extern FRACTION
     7                                  extern COORDINATES
     8                                  extern stdout 
     9                                  
    10                                  ;----------------------------------------------
    11                                  ; Вычисление периметра прямоугольника
    12                                  ;double PerimeterRectangle(void *r) {
    13                                  ;    return 2.0 * (*((int*)r)
    14                                  ;           + *((int*)(r+intSize)));
    15                                  ;}
    16                                  
    17                                  global sqrti
    18                                  sqrti:
    19 00000000 4C89CB                      mov rbx, r9
    20 00000003 4831C0                      xor rax, rax
    21                                  
    22                                      .while:
    23 00000006 4839D8                      cmp rax, rbx
    24 00000009 7311                        jnb .endwhile
    25                                  
    26 0000000B 4801C3                      add rbx, rax
    27 0000000E 48D1EB                      shr rbx, 1
    28                                  
    29 00000011 4C89C8                      mov rax, r9
    30 00000014 4831D2                      xor rdx, rdx
    31 00000017 48F7F3                      div rbx
    32                                  
    33 0000001A EBEA                        jmp .while
    34                                  
    35                                      .endwhile:
    36 0000001C 4889D8                      mov rax, rbx
    37 0000001F C3                          ret
    38                                  
    39                                  
    40                                  global ToRealComplexNumber
    41                                  ToRealComplexNumber:
    42                                  section .data
    43 00000000 19000000                X dd 25
    44                                  section .text
    45 00000020 55                      push rbp
    46 00000021 4889E5                  mov rbp, rsp
    47                                  
    48                                      ; В rdi адрес прямоугольника
    49 00000024 4831C0                      xor rax, rax
    50 00000027 8B07                        mov eax, [rdi]
    51 00000029 8B5F04                      mov ebx, [rdi+4]
    52 0000002C 0FAFC0                      imul eax, eax
    53 0000002F 0FAFDB                      imul ebx, ebx
    54 00000032 01D8                        add eax, ebx 
    55 00000034 BB02000000                  mov ebx, 2 ; TODO take square root
    56 00000039 F7F3                        div ebx
    57                                  breakpoint:
    58 0000003B 4D31C9                      xor r9, r9
    59 0000003E 4189C1                      mov r9d, eax
    60 00000041 E8BAFFFFFF                  call sqrti
    61 00000046 4889D8                      mov rax, rbx
    62                                      
    63                                      ;call sqrti
    64 00000049 F20F2AC0                    cvtsi2sd    xmm0, eax
    65                                      
    66 0000004D 4883C708                    add rdi, 8
    67 00000051 8907                        mov dword[rdi], eax
    68 00000053 4883EF08                    sub rdi, 8
    69                                  
    70 00000057 C9                      leave
    71 00000058 C3                      ret
    72                                  
    73                                  ;----------------------------------------------
    74                                  ; double PerimeterTriangle(void *t) {
    75                                  ;    return (double)(*((int*)t)
    76                                  ;       + *((int*)(t+intSize))
    77                                  ;       + *((int*)(t+2*intSize)));
    78                                  ;}
    79                                  global ToRealFraction
    80                                  ToRealFraction:
    81                                  section .text
    82 00000059 55                      push rbp
    83 0000005A 4889E5                  mov rbp, rsp
    84                                  
    85                                      ; В rdi адрес треугольника
    86 0000005D 8B07                        mov eax, [rdi]
    87 0000005F 8B5F04                      mov ebx, [rdi+4]
    88                                      
    89 00000062 83FB00                      cmp ebx, 0
    90 00000065 7402                        je zerodenom
    91 00000067 F7F3                        div ebx
    92                                  
    93                                      zerodenom:
    94                                  
    95                                      ; mov eax, [rdi+4]
    96 00000069 F20F2AC0                    cvtsi2sd    xmm0, eax
    97 0000006D 4883C708                    add rdi, 8
    98 00000071 8907                        mov dword[rdi], eax
    99 00000073 4883EF08                    sub rdi, 8
   100                                      
   101 00000077 C9                      leave
   102 00000078 C3                      ret
   103                                  
   104                                  global ToRealCoordinates
   105                                  ToRealCoordinates:
   106                                  section .text
   107 00000079 55                      push rbp
   108 0000007A 4889E5                  mov rbp, rsp
   109                                  
   110                                      ; В rdi адрес треугольника
   111 0000007D 8B4704                      mov eax, [rdi+4]
   112 00000080 F20F2AC0                    cvtsi2sd    xmm0, eax
   113 00000084 4883C708                    add rdi, 8
   114 00000088 8907                        mov dword[rdi], eax
   115 0000008A 4883EF08                    sub rdi, 8
   116                                  
   117 0000008E C9                      leave
   118 0000008F C3                      ret
   119                                  ;----------------------------------------------
   120                                  ; Вычисление периметра фигуры
   121                                  ;double PerimeterShape(void *s) {
   122                                  ;    int k = *((int*)s);
   123                                  ;    if(k == RECTANGLE) {
   124                                  ;        return PerimeterRectangle(s+intSize);
   125                                  ;    }
   126                                  ;    else if(k == TRIANGLE) {
   127                                  ;        return PerimeterTriangle(s+intSize);
   128                                  ;    }
   129                                  ;    else {
   130                                  ;        return 0.0;
   131                                  ;    }
   132                                  ;}
   133                                  global ToRealNumber
   134                                  ToRealNumber:
   135                                  section .text
   136 00000090 55                      push rbp
   137 00000091 4889E5                  mov rbp, rsp
   138                                  
   139                                      ; В rdi адрес фигуры
   140                                      ; PrintStr2 "toreall:", [stdout]
   141 00000094 8B07                        mov eax, [rdi]
   142 00000096 3B0425[00000000]            cmp eax, [COMPLEXNUMBER]
   143 0000009D 741A                        je compToReal
   144 0000009F 3B0425[00000000]            cmp eax, [FRACTION]
   145 000000A6 741C                        je fracToReal
   146 000000A8 3B0425[00000000]            cmp eax, [COORDINATES]
   147 000000AF 741E                        je cordToReal
   148 000000B1 31C0                        xor eax, eax
   149 000000B3 F20F2AC0                    cvtsi2sd    xmm0, eax
   150 000000B7 EB21                        jmp     return
   151                                  compToReal:
   152                                      ; Вычисление периметра прямоугольника
   153                                      ;  PrintStr2 "complex:", stdout
   154 000000B9 4883C704                    add     rdi, 4
   155 000000BD E85EFFFFFF                  call    ToRealComplexNumber
   156 000000C2 EB16                        jmp     return
   157                                  fracToReal:
   158                                      ; PrintStr2 "fraction:", stdout
   159                                      ; Вычисление периметра прямоугольника
   160 000000C4 4883C704                    add     rdi, 4
   161 000000C8 E88CFFFFFF                  call    ToRealFraction
   162 000000CD EB0B                        jmp     return
   163                                  cordToReal:
   164                                      ; PrintStr2 "coordinates:", stdout
   165                                      ; Вычисление периметра прямоугольника
   166 000000CF 4883C704                    add     rdi, 4
   167 000000D3 E8A1FFFFFF                  call    ToRealCoordinates
   168 000000D8 EB00                        jmp     return
   169                                  
   170                                  return:
   171 000000DA C9                      leave
   172 000000DB C3                      ret
   173                                  
   174                                  ;----------------------------------------------
   175                                  ;// Вычисление суммы периметров всех фигур в контейнере
   176                                  ;double PerimeterSumContainer(void *c, int len) {
   177                                  ;    double sum = 0.0;
   178                                  ;    void *tmp = c;
   179                                  ;    for(int i = 0; i < len; i++) {
   180                                  ;        sum += PerimeterShape(tmp);
   181                                  ;        tmp = tmp + shapeSize;
   182                                  ;    }
   183                                  ;    return sum;
   184                                  ;}
