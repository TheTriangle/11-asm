     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fprintf
     4                                  
     5                                  extern ToRealComplexNumber
     6                                  extern ToRealFraction
     7                                  extern ToRealCoordinates
     8                                  
     9                                  extern COMPLEXNUMBER
    10                                  extern FRACTION
    11                                  extern COORDINATES
    12                                  
    13                                  ;----------------------------------------------
    14                                  ;// Вывод параметров прямоугольника в файл
    15                                  ;void OutRectangle(void *r, FILE *ofst) {
    16                                  ;    fprintf(ofst, "It is Rectangle: x = %d, y = %d. Perimeter = %g\n",
    17                                  ;            *((int*)r), *((int*)(r+intSize)), PerimeterRectangle(r));
    18                                  ;}
    19                                  global OutComplexNumber
    20                                  OutComplexNumber:
    21                                  section .data
    22 00000000 436F6D706C6578206E-         .outfmt db "Complex number (%d, %d) - %g",10,0
    22 00000009 756D62657220282564-
    22 00000012 2C20256429202D2025-
    22 0000001B 670A00             
    23                                  section .bss
    24 00000000 <res 00000008>              .pcomp  resq  1
    25 00000008 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    26 00000010 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
    27                                  section .text
    28 00000000 55                      push rbp
    29 00000001 4889E5                  mov rbp, rsp
    30                                  
    31                                      ; Сохранени принятых аргументов
    32 00000004 48893C25[00000000]          mov     [.pcomp], rdi          ; сохраняется адрес прямоугольника
    33 0000000C 48893425[08000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    34                                  
    35                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
    36 00000014 E8(00000000)                call    ToRealComplexNumber
    37 00000019 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    37 0000001E [10000000]         
    38                                  
    39                                      ; Вывод информации о прямоугольнике в консоль
    40                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    41                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
    42                                  ;     mov     esi, [rax]          ; x
    43                                  ;     mov     edx, [rax+4]        ; y
    44                                  ;     movsd   xmm0, [.p]
    45                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    46                                  ;     call    printf
    47                                  
    48                                      ; Вывод информации о прямоугольнике в файл
    49 00000022 488B3C25[08000000]          mov     rdi, [.FILE]
    50 0000002A 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    50 0000002C [0000000000000000] 
    51 00000034 488B0425[00000000]          mov     rax, [.pcomp]        ; адрес прямоугольника
    52 0000003C 8B10                        mov     edx, [rax]          ; x
    53 0000003E 8B4804                      mov     ecx, [rax+4]        ; y
    54 00000041 F20F100425-                 movsd   xmm0, [.p]
    54 00000046 [10000000]         
    55 0000004A B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    56 0000004F E8(00000000)                call    fprintf
    57                                  
    58 00000054 C9                      leave
    59 00000055 C3                      ret
    60                                  
    61                                  ;----------------------------------------------
    62                                  ; // Вывод параметров треугольника в файл
    63                                  ; void OutTriangle(void *t, FILE *ofst) {
    64                                  ;     fprintf(ofst, "It is Triangle: a = %d, b = %d, c = %d. Perimeter = %g\n",
    65                                  ;            *((int*)t), *((int*)(t+intSize)), *((int*)(t+2*intSize)),
    66                                  ;             PerimeterTriangle(t));
    67                                  ; }
    68                                  global OutFraction
    69                                  OutFraction:
    70                                  section .data
    71 0000001E 4672616374696F6E20-         .outfmt db "Fraction %d/%d - %g",10,0
    71 00000027 25642F2564202D2025-
    71 00000030 670A00             
    72                                  section .bss
    73 00000018 <res 00000008>              .frac  resq  1
    74 00000020 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    75 00000028 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
    76                                  section .text
    77 00000056 55                      push rbp
    78 00000057 4889E5                  mov rbp, rsp
    79                                  
    80                                      ; Сохранени принятых аргументов
    81 0000005A 48893C25[18000000]          mov     [.frac], rdi          ; сохраняется адрес прямоугольника
    82 00000062 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    83                                  
    84                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
    85 0000006A E8(00000000)                call    ToRealFraction
    86 0000006F F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    86 00000074 [28000000]         
    87                                  
    88                                      ; Вывод информации о прямоугольнике в консоль
    89                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    90                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
    91                                  ;     mov     esi, [rax]          ; x
    92                                  ;     mov     edx, [rax+4]        ; y
    93                                  ;     movsd   xmm0, [.p]
    94                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    95                                  ;     call    printf
    96                                  
    97                                      ; Вывод информации о прямоугольнике в файл
    98 00000078 488B3C25[20000000]          mov     rdi, [.FILE]
    99 00000080 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    99 00000082 [1E00000000000000] 
   100 0000008A 488B0425[18000000]          mov     rax, [.frac]        ; адрес прямоугольника
   101 00000092 8B10                        mov     edx, [rax]          ; x
   102 00000094 8B4804                      mov     ecx, [rax+4]        ; y
   103 00000097 F20F100425-                 movsd   xmm0, [.p]
   103 0000009C [28000000]         
   104 000000A0 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   105 000000A5 E8(00000000)                call    fprintf
   106                                  
   107 000000AA C9                      leave
   108 000000AB C3                      ret
   109                                  
   110                                  
   111                                  global OutCoordinates
   112                                  OutCoordinates:
   113                                  section .data
   114 00000033 436F6F72696E617465-         .outfmt db "Coorinates (%d, %d) - %g",10,0
   114 0000003C 73202825642C202564-
   114 00000045 29202D2025670A00   
   115                                  section .bss
   116 00000030 <res 00000008>              .pcoord  resq  1
   117 00000038 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
   118 00000040 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
   119                                  section .text
   120 000000AC 55                      push rbp
   121 000000AD 4889E5                  mov rbp, rsp
   122                                  
   123                                      ; Сохранени принятых аргументов
   124 000000B0 48893C25[30000000]          mov     [.pcoord], rdi          ; сохраняется адрес прямоугольника
   125 000000B8 48893425[38000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   126                                  
   127                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
   128 000000C0 E8(00000000)                call    ToRealCoordinates
   129 000000C5 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
   129 000000CA [40000000]         
   130                                  
   131                                      ; Вывод информации о прямоугольнике в консоль
   132                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
   133                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
   134                                  ;     mov     esi, [rax]          ; x
   135                                  ;     mov     edx, [rax+4]        ; y
   136                                  ;     movsd   xmm0, [.p]
   137                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
   138                                  ;     call    printf
   139                                  
   140                                      ; Вывод информации о прямоугольнике в файл
   141 000000CE 488B3C25[38000000]          mov     rdi, [.FILE]
   142 000000D6 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
   142 000000D8 [3300000000000000] 
   143 000000E0 488B0425[30000000]          mov     rax, [.pcoord]        ; адрес прямоугольника
   144 000000E8 8B10                        mov     edx, [rax]          ; x
   145 000000EA 8B4804                      mov     ecx, [rax+4]        ; y
   146 000000ED F20F100425-                 movsd   xmm0, [.p]
   146 000000F2 [40000000]         
   147 000000F6 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   148 000000FB E8(00000000)                call    fprintf
   149                                  
   150 00000100 C9                      leave
   151 00000101 C3                      ret
   152                                  ;----------------------------------------------
   153                                  ; // Вывод параметров текущей фигуры в файл
   154                                  ; void OutShape(void *s, FILE *ofst) {
   155                                  ;     int k = *((int*)s);
   156                                  ;     if(k == RECTANGLE) {
   157                                  ;         OutRectangle(s+intSize, ofst);
   158                                  ;     }
   159                                  ;     else if(k == TRIANGLE) {
   160                                  ;         OutTriangle(s+intSize, ofst);
   161                                  ;     }
   162                                  ;     else {
   163                                  ;         fprintf(ofst, "Incorrect figure!\n");
   164                                  ;     }
   165                                  ; }
   166                                  global OutNumber
   167                                  OutNumber:
   168                                  section .data
   169 0000004D 496E636F7272656374-         .erShape db "Incorrect number!",10,0
   169 00000056 206E756D626572210A-
   169 0000005F 00                 
   170                                  section .text
   171 00000102 55                      push rbp
   172 00000103 4889E5                  mov rbp, rsp
   173                                  
   174                                      ; В rdi адрес фигуры
   175 00000106 8B07                        mov eax, [rdi]
   176 00000108 3B0425[00000000]            cmp eax, [COMPLEXNUMBER]
   177 0000010F 7428                        je compOut
   178 00000111 3B0425[00000000]            cmp eax, [FRACTION]
   179 00000118 742A                        je fracOut
   180 0000011A 3B0425[00000000]            cmp eax, [COORDINATES]
   181 00000121 742C                        je cordOut
   182 00000123 48BF-                       mov rdi, .erShape
   182 00000125 [4D00000000000000] 
   183 0000012D B800000000                  mov rax, 0
   184 00000132 E8(00000000)                call fprintf
   185 00000137 EB21                        jmp     return
   186                                  compOut:
   187                                      ; Вывод прямоугольника
   188 00000139 4883C704                    add     rdi, 4
   189 0000013D E8BEFEFFFF                  call    OutComplexNumber
   190 00000142 EB16                        jmp     return
   191                                  fracOut:
   192                                      ; Вывод прямоугольника
   193 00000144 4883C704                    add     rdi, 4
   194 00000148 E809FFFFFF                  call    OutFraction
   195 0000014D EB0B                        jmp     return
   196                                  cordOut:
   197                                      ; Вывод прямоугольника
   198 0000014F 4883C704                    add     rdi, 4
   199 00000153 E854FFFFFF                  call    OutCoordinates
   200 00000158 EB00                        jmp     return
   201                                  return:
   202 0000015A C9                      leave
   203 0000015B C3                      ret
   204                                  
   205                                  ;----------------------------------------------
   206                                  ; // Вывод содержимого контейнера в файл
   207                                  ; void OutContainer(void *c, int len, FILE *ofst) {
   208                                  ;     void *tmp = c;
   209                                  ;     fprintf(ofst, "Container contains %d elements.\n", len);
   210                                  ;     for(int i = 0; i < len; i++) {
   211                                  ;         fprintf(ofst, "%d: ", i);
   212                                  ;         OutShape(tmp, ofst);
   213                                  ;         tmp = tmp + shapeSize;
   214                                  ;     }
   215                                  ; }
   216                                  global OutContainer
   217                                  OutContainer:
   218                                  section .data
   219 00000060 25643A2000                  numFmt  db  "%d: ",0
   220                                  section .bss
   221 00000048 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   222 00000050 <res 00000004>              .len    resd    1   ; адрес для сохранения числа введенных элементов
   223 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   224                                  section .text
   225 0000015C 55                      push rbp
   226 0000015D 4889E5                  mov rbp, rsp
   227                                  
   228 00000160 48893C25[48000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   229 00000168 893425[50000000]            mov [.len],   esi     ; сохраняется число элементов
   230 0000016F 48891425[54000000]          mov [.FILE],  rdx    ; сохраняется указатель на файл
   231                                  
   232                                      ; В rdi адрес начала контейнера
   233 00000177 4889F3                      mov rbx, rsi            ; число фигур
   234 0000017A 31C9                        xor ecx, ecx            ; счетчик фигур = 0
   235 0000017C 4889D6                      mov rsi, rdx            ; перенос указателя на файл
   236                                  .loop:
   237 0000017F 39D9                        cmp ecx, ebx            ; проверка на окончание цикла
   238 00000181 7D4D                        jge .return             ; Перебрали все фигуры
   239                                  
   240 00000183 53                          push rbx
   241 00000184 51                          push rcx
   242                                  
   243                                      ; Вывод номера фигуры
   244 00000185 488B3C25[54000000]          mov     rdi, [.FILE]    ; текущий указатель на файл
   245 0000018D 48BE-                       mov     rsi, numFmt     ; формат для вывода фигуры
   245 0000018F [6000000000000000] 
   246 00000197 89CA                        mov     edx, ecx        ; индекс текущей фигуры
   247 00000199 4831C0                      xor     rax, rax,       ; только целочисленные регистры
   248 0000019C E8(00000000)                call fprintf
   249                                  
   250                                      ; Вывод текущей фигуры
   251 000001A1 488B3C25[48000000]          mov     rdi, [.pcont]
   252 000001A9 488B3425[54000000]          mov     rsi, [.FILE]
   253 000001B1 E84CFFFFFF                  call OutNumber     ; Получение периметра первой фигуры
   254                                  
   255 000001B6 59                          pop rcx
   256 000001B7 5B                          pop rbx
   257 000001B8 FFC1                        inc ecx                 ; индекс следующей фигуры
   258                                  
   259 000001BA 488B0425[48000000]          mov     rax, [.pcont]
   260 000001C2 4883C010                    add     rax, 16         ; адрес следующей фигуры
   261 000001C6 48890425[48000000]          mov     [.pcont], rax
   262 000001CE EBAF                        jmp .loop
   263                                  .return:
   264 000001D0 C9                      leave
   265 000001D1 C3                      ret
   266                                  
