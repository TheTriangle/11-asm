     1                                  ;------------------------------------------------------------------------------
     2                                  ; perimeter.asm - единица компиляции, вбирающая функции вычисления периметра
     3                                  ;------------------------------------------------------------------------------
     4                                  
     5                                  extern COMPLEXNUMBER
     6                                  extern FRACTION
     7                                  extern COORDINATES
     8                                  
     9                                  ;----------------------------------------------
    10                                  ; Вычисление периметра прямоугольника
    11                                  ;double PerimeterRectangle(void *r) {
    12                                  ;    return 2.0 * (*((int*)r)
    13                                  ;           + *((int*)(r+intSize)));
    14                                  ;}
    15                                  global ToRealComplexNumber
    16                                  ToRealComplexNumber:
    17                                  section .text
    18 00000000 55                      push rbp
    19 00000001 4889E5                  mov rbp, rsp
    20                                  
    21                                      ; В rdi адрес прямоугольника
    22 00000004 8B07                        mov eax, [rdi]
    23 00000006 8B5F04                      mov ebx, [rdi+4]
    24 00000009 0FAFC0                      imul eax, eax
    25 0000000C 0FAFDB                      imul ebx, ebx
    26 0000000F 01D8                        add eax, ebx 
    27 00000011 BB02000000                  mov ebx, 2 ; TODO take square root
    28 00000016 F7F3                        div ebx
    29 00000018 F20F2AC0                    cvtsi2sd    xmm0, eax
    30                                  
    31 0000001C C9                      leave
    32 0000001D C3                      ret
    33                                  
    34                                  ;----------------------------------------------
    35                                  ; double PerimeterTriangle(void *t) {
    36                                  ;    return (double)(*((int*)t)
    37                                  ;       + *((int*)(t+intSize))
    38                                  ;       + *((int*)(t+2*intSize)));
    39                                  ;}
    40                                  global ToRealFraction
    41                                  ToRealFraction:
    42                                  section .text
    43 0000001E 55                      push rbp
    44 0000001F 4889E5                  mov rbp, rsp
    45                                  
    46                                      ; В rdi адрес треугольника
    47 00000022 8B07                        mov eax, [rdi]
    48 00000024 8B5F04                      mov ebx, [rdi+4]
    49 00000027 F7F3                        div ebx
    50                                      ; mov eax, [rdi+4]
    51 00000029 F20F2AC0                    cvtsi2sd    xmm0, eax
    52                                      
    53 0000002D C9                      leave
    54 0000002E C3                      ret
    55                                  
    56                                  global ToRealCoordinates
    57                                  ToRealCoordinates:
    58                                  section .text
    59 0000002F 55                      push rbp
    60 00000030 4889E5                  mov rbp, rsp
    61                                  
    62                                      ; В rdi адрес треугольника
    63 00000033 8B4704                      mov eax, [rdi+4]
    64 00000036 F20F2AC0                    cvtsi2sd    xmm0, eax
    65                                  
    66 0000003A C9                      leave
    67 0000003B C3                      ret
    68                                  ;----------------------------------------------
    69                                  ; Вычисление периметра фигуры
    70                                  ;double PerimeterShape(void *s) {
    71                                  ;    int k = *((int*)s);
    72                                  ;    if(k == RECTANGLE) {
    73                                  ;        return PerimeterRectangle(s+intSize);
    74                                  ;    }
    75                                  ;    else if(k == TRIANGLE) {
    76                                  ;        return PerimeterTriangle(s+intSize);
    77                                  ;    }
    78                                  ;    else {
    79                                  ;        return 0.0;
    80                                  ;    }
    81                                  ;}
    82                                  global ToRealNumber
    83                                  ToRealNumber:
    84                                  section .text
    85 0000003C 55                      push rbp
    86 0000003D 4889E5                  mov rbp, rsp
    87                                  
    88                                      ; В rdi адрес фигуры
    89 00000040 8B07                        mov eax, [rdi]
    90 00000042 3B0425[00000000]            cmp eax, [COMPLEXNUMBER]
    91 00000049 741A                        je compToReal
    92 0000004B 3B0425[00000000]            cmp eax, [FRACTION]
    93 00000052 741C                        je fracToReal
    94 00000054 3B0425[00000000]            cmp eax, [COORDINATES]
    95 0000005B 741E                        je cordToReal
    96 0000005D 31C0                        xor eax, eax
    97 0000005F F20F2AC0                    cvtsi2sd    xmm0, eax
    98 00000063 EB21                        jmp     return
    99                                  compToReal:
   100                                      ; Вычисление периметра прямоугольника
   101 00000065 4883C704                    add     rdi, 4
   102 00000069 E892FFFFFF                  call    ToRealComplexNumber
   103 0000006E EB16                        jmp     return
   104                                  fracToReal:
   105                                      ; Вычисление периметра прямоугольника
   106 00000070 4883C704                    add     rdi, 4
   107 00000074 E8A5FFFFFF                  call    ToRealFraction
   108 00000079 EB0B                        jmp     return
   109                                  cordToReal:
   110                                      ; Вычисление периметра прямоугольника
   111 0000007B 4883C704                    add     rdi, 4
   112 0000007F E8ABFFFFFF                  call    ToRealCoordinates
   113 00000084 EB00                        jmp     return
   114                                  
   115                                  return:
   116 00000086 C9                      leave
   117 00000087 C3                      ret
   118                                  
   119                                  ;----------------------------------------------
   120                                  ;// Вычисление суммы периметров всех фигур в контейнере
   121                                  ;double PerimeterSumContainer(void *c, int len) {
   122                                  ;    double sum = 0.0;
   123                                  ;    void *tmp = c;
   124                                  ;    for(int i = 0; i < len; i++) {
   125                                  ;        sum += PerimeterShape(tmp);
   126                                  ;        tmp = tmp + shapeSize;
   127                                  ;    }
   128                                  ;    return sum;
   129                                  ;}
   130                                  global PerimeterSumContainer
   131                                  PerimeterSumContainer:
   132                                  section .data
   133 00000000 0000000000000000            .sum    dq  0.0
   134                                  section .text
   135 00000088 55                      push rbp
   136 00000089 4889E5                  mov rbp, rsp
   137                                  
   138                                      ; В rdi адрес начала контейнера
   139 0000008C 89F3                        mov ebx, esi            ; число фигур
   140 0000008E 31C9                        xor ecx, ecx            ; счетчик фигур
   141 00000090 F20F100C25-                 movsd xmm1, [.sum]      ; перенос накопителя суммы в регистр 1
   141 00000095 [00000000]         
   142                                  .loop:
   143 00000099 39D9                        cmp ecx, ebx            ; проверка на окончание цикла
   144 0000009B 7D18                        jge .return             ; Перебрали все фигуры
   145                                  
   146 0000009D 4989FA                      mov r10, rdi            ; сохранение начала фигуры
   147 000000A0 E897FFFFFF                  call ToRealNumber     ; Получение периметра первой фигуры
   148 000000A5 F20F58C8                    addsd xmm1, xmm0        ; накопление суммы
   149 000000A9 48FFC1                      inc rcx                 ; индекс следующей фигуры
   150 000000AC 4983C210                    add r10, 16             ; адрес следующей фигуры
   151 000000B0 4C89D7                      mov rdi, r10            ; восстановление для передачи параметра
   152 000000B3 EBE4                        jmp .loop
   153                                  .return:
   154 000000B5 F20F10C1                    movsd xmm0, xmm1
   155 000000B9 C9                      leave
   156 000000BA C3                      ret
