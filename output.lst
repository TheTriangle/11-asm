     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fprintf
     4                                  
     5                                  extern ToRealComplexNumber
     6                                  extern ToRealFraction
     7                                  extern ToRealCoordinates
     8                                  extern ToRealNumber
     9                                  
    10                                  extern COMPLEXNUMBER
    11                                  extern FRACTION
    12                                  extern COORDINATES
    13                                  
    14                                  ;----------------------------------------------
    15                                  ;// Вывод параметров прямоугольника в файл
    16                                  ;void OutRectangle(void *r, FILE *ofst) {
    17                                  ;    fprintf(ofst, "It is Rectangle: x = %d, y = %d. Perimeter = %g\n",
    18                                  ;            *((int*)r), *((int*)(r+intSize)), PerimeterRectangle(r));
    19                                  ;}
    20                                  
    21                                  
    22                                  global OutComplexNumber
    23                                  OutComplexNumber:
    24                                  section .data
    25 00000000 436F6D706C6578206E-         .outfmt db "Complex number (%d, %d) - %g",10,0
    25 00000009 756D62657220282564-
    25 00000012 2C20256429202D2025-
    25 0000001B 670A00             
    26                                  section .bss
    27 00000000 <res 00000008>              .pcomp  resq  1
    28 00000008 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    29 00000010 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
    30                                  section .text
    31 00000000 55                      push rbp
    32 00000001 4889E5                  mov rbp, rsp
    33                                  
    34                                      ; Сохранени принятых аргументов
    35 00000004 48893C25[00000000]          mov     [.pcomp], rdi          ; сохраняется адрес прямоугольника
    36 0000000C 48893425[08000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    37                                  
    38                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
    39 00000014 4883EF04                    sub rdi, 4
    40 00000018 E8(00000000)                call    ToRealNumber
    41 0000001D 4883C704                    add rdi, 4
    42 00000021 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    42 00000026 [10000000]         
    43                                  
    44                                      ; Вывод информации о прямоугольнике в консоль
    45                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    46                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
    47                                  ;     mov     esi, [rax]          ; x
    48                                  ;     mov     edx, [rax+4]        ; y
    49                                  ;     movsd   xmm0, [.p]
    50                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    51                                  ;     call    printf
    52                                  
    53                                      ; Вывод информации о прямоугольнике в файл
    54 0000002A 488B3C25[08000000]          mov     rdi, [.FILE]
    55 00000032 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    55 00000034 [0000000000000000] 
    56 0000003C 488B0425[00000000]          mov     rax, [.pcomp]        ; адрес прямоугольника
    57 00000044 8B10                        mov     edx, [rax]          ; x
    58 00000046 8B4804                      mov     ecx, [rax+4]        ; y
    59 00000049 F20F100425-                 movsd   xmm0, [.p]
    59 0000004E [10000000]         
    60 00000052 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    61 00000057 E8(00000000)                call    fprintf
    62                                  
    63 0000005C C9                      leave
    64 0000005D C3                      ret
    65                                  
    66                                  ;----------------------------------------------
    67                                  ; // Вывод параметров треугольника в файл
    68                                  ; void OutTriangle(void *t, FILE *ofst) {
    69                                  ;     fprintf(ofst, "It is Triangle: a = %d, b = %d, c = %d. Perimeter = %g\n",
    70                                  ;            *((int*)t), *((int*)(t+intSize)), *((int*)(t+2*intSize)),
    71                                  ;             PerimeterTriangle(t));
    72                                  ; }
    73                                  global OutFraction
    74                                  OutFraction:
    75                                  section .data
    76 0000001E 4672616374696F6E20-         .outfmt db "Fraction %d/%d - %g",10,0
    76 00000027 25642F2564202D2025-
    76 00000030 670A00             
    77                                  section .bss
    78 00000018 <res 00000008>              .frac  resq  1
    79 00000020 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    80 00000028 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
    81                                  section .text
    82 0000005E 55                      push rbp
    83 0000005F 4889E5                  mov rbp, rsp
    84                                  
    85                                      ; Сохранени принятых аргументов
    86 00000062 48893C25[18000000]          mov     [.frac], rdi          ; сохраняется адрес прямоугольника
    87 0000006A 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    88                                  
    89                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
    90 00000072 E8(00000000)                call    ToRealFraction
    91 00000077 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    91 0000007C [28000000]         
    92                                  
    93                                      ; Вывод информации о прямоугольнике в консоль
    94                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    95                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
    96                                  ;     mov     esi, [rax]          ; x
    97                                  ;     mov     edx, [rax+4]        ; y
    98                                  ;     movsd   xmm0, [.p]
    99                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
   100                                  ;     call    printf
   101                                  
   102                                      ; Вывод информации о прямоугольнике в файл
   103 00000080 488B3C25[20000000]          mov     rdi, [.FILE]
   104 00000088 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
   104 0000008A [1E00000000000000] 
   105 00000092 488B0425[18000000]          mov     rax, [.frac]        ; адрес прямоугольника
   106 0000009A 8B10                        mov     edx, [rax]          ; x
   107 0000009C 8B4804                      mov     ecx, [rax+4]        ; y
   108 0000009F F20F100425-                 movsd   xmm0, [.p]
   108 000000A4 [28000000]         
   109 000000A8 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   110 000000AD E8(00000000)                call    fprintf
   111                                  
   112 000000B2 C9                      leave
   113 000000B3 C3                      ret
   114                                  
   115                                  
   116                                  global OutCoordinates
   117                                  OutCoordinates:
   118                                  section .data
   119 00000033 436F6F72696E617465-         .outfmt db "Coorinates (%d, %d) - %g",10,0
   119 0000003C 73202825642C202564-
   119 00000045 29202D2025670A00   
   120                                  section .bss
   121 00000030 <res 00000008>              .pcoord  resq  1
   122 00000038 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
   123 00000040 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
   124                                  section .text
   125 000000B4 55                      push rbp
   126 000000B5 4889E5                  mov rbp, rsp
   127                                  
   128                                      ; Сохранени принятых аргументов
   129 000000B8 48893C25[30000000]          mov     [.pcoord], rdi          ; сохраняется адрес прямоугольника
   130 000000C0 48893425[38000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   131                                  
   132                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
   133 000000C8 E8(00000000)                call    ToRealCoordinates
   134 000000CD F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
   134 000000D2 [40000000]         
   135                                      ; Вывод информации о прямоугольнике в консоль
   136                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
   137                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
   138                                  ;     mov     esi, [rax]          ; x
   139                                  ;     mov     edx, [rax+4]        ; y
   140                                  ;     movsd   xmm0, [.p]
   141                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
   142                                  ;     call    printf
   143                                  
   144                                      ; Вывод информации о прямоугольнике в файл
   145 000000D6 488B3C25[38000000]          mov     rdi, [.FILE]
   146 000000DE 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
   146 000000E0 [3300000000000000] 
   147 000000E8 488B0425[30000000]          mov     rax, [.pcoord]        ; адрес прямоугольника
   148 000000F0 8B10                        mov     edx, [rax]          ; x
   149 000000F2 8B4804                      mov     ecx, [rax+4]        ; y
   150 000000F5 F20F100425-                 movsd   xmm0, [.p]
   150 000000FA [40000000]         
   151 000000FE B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   152 00000103 E8(00000000)                call    fprintf
   153                                  
   154 00000108 C9                      leave
   155 00000109 C3                      ret
   156                                  ;----------------------------------------------
   157                                  ; // Вывод параметров текущей фигуры в файл
   158                                  ; void OutShape(void *s, FILE *ofst) {
   159                                  ;     int k = *((int*)s);
   160                                  ;     if(k == RECTANGLE) {
   161                                  ;         OutRectangle(s+intSize, ofst);
   162                                  ;     }
   163                                  ;     else if(k == TRIANGLE) {
   164                                  ;         OutTriangle(s+intSize, ofst);
   165                                  ;     }
   166                                  ;     else {
   167                                  ;         fprintf(ofst, "Incorrect figure!\n");
   168                                  ;     }
   169                                  ; }
   170                                  global OutNumber
   171                                  OutNumber:
   172                                  section .data
   173 0000004D 496E636F7272656374-         .erShape db "Incorrect number!",10,0
   173 00000056 206E756D626572210A-
   173 0000005F 00                 
   174                                  section .text
   175 0000010A 55                      push rbp
   176 0000010B 4889E5                  mov rbp, rsp
   177                                  
   178                                      ; В rdi адрес фигуры
   179 0000010E 8B07                        mov eax, [rdi]
   180 00000110 3B0425[00000000]            cmp eax, [COMPLEXNUMBER]
   181 00000117 7428                        je compOut
   182 00000119 3B0425[00000000]            cmp eax, [FRACTION]
   183 00000120 742A                        je fracOut
   184 00000122 3B0425[00000000]            cmp eax, [COORDINATES]
   185 00000129 742C                        je cordOut
   186 0000012B 48BF-                       mov rdi, .erShape
   186 0000012D [4D00000000000000] 
   187 00000135 B800000000                  mov rax, 0
   188 0000013A E8(00000000)                call fprintf
   189 0000013F EB21                        jmp     return
   190                                  compOut:
   191                                      ; Вывод прямоугольника
   192 00000141 4883C704                    add     rdi, 4
   193 00000145 E8B6FEFFFF                  call    OutComplexNumber
   194 0000014A EB16                        jmp     return
   195                                  fracOut:
   196                                      ; Вывод прямоугольника
   197 0000014C 4883C704                    add     rdi, 4
   198 00000150 E809FFFFFF                  call    OutFraction
   199 00000155 EB0B                        jmp     return
   200                                  cordOut:
   201                                      ; Вывод прямоугольника
   202 00000157 4883C704                    add     rdi, 4
   203 0000015B E854FFFFFF                  call    OutCoordinates
   204 00000160 EB00                        jmp     return
   205                                  return:
   206 00000162 C9                      leave
   207 00000163 C3                      ret
   208                                  
   209                                  ;----------------------------------------------
   210                                  ; // Вывод содержимого контейнера в файл
   211                                  ; void OutContainer(void *c, int len, FILE *ofst) {
   212                                  ;     void *tmp = c;
   213                                  ;     fprintf(ofst, "Container contains %d elements.\n", len);
   214                                  ;     for(int i = 0; i < len; i++) {
   215                                  ;         fprintf(ofst, "%d: ", i);
   216                                  ;         OutShape(tmp, ofst);
   217                                  ;         tmp = tmp + shapeSize;
   218                                  ;     }
   219                                  ; }
   220                                  global OutContainer
   221                                  OutContainer:
   222                                  section .data
   223 00000060 25643A2000                  numFmt  db  "%d: ",0
   224                                  section .bss
   225 00000048 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   226 00000050 <res 00000004>              .len    resd    1   ; адрес для сохранения числа введенных элементов
   227 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   228                                  section .text
   229 00000164 55                      push rbp
   230 00000165 4889E5                  mov rbp, rsp
   231                                  
   232 00000168 48893C25[48000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   233 00000170 893425[50000000]            mov [.len],   esi     ; сохраняется число элементов
   234 00000177 48891425[54000000]          mov [.FILE],  rdx    ; сохраняется указатель на файл
   235                                  
   236                                      ; В rdi адрес начала контейнера
   237 0000017F 4889F3                      mov rbx, rsi            ; число фигур
   238 00000182 31C9                        xor ecx, ecx            ; счетчик фигур = 0
   239 00000184 4889D6                      mov rsi, rdx            ; перенос указателя на файл
   240                                  .loop:
   241 00000187 39D9                        cmp ecx, ebx            ; проверка на окончание цикла
   242 00000189 7D4D                        jge .return             ; Перебрали все фигуры
   243                                  
   244 0000018B 53                          push rbx
   245 0000018C 51                          push rcx
   246                                  
   247                                      ; Вывод номера фигуры
   248 0000018D 488B3C25[54000000]          mov     rdi, [.FILE]    ; текущий указатель на файл
   249 00000195 48BE-                       mov     rsi, numFmt     ; формат для вывода фигуры
   249 00000197 [6000000000000000] 
   250 0000019F 89CA                        mov     edx, ecx        ; индекс текущей фигуры
   251 000001A1 4831C0                      xor     rax, rax,       ; только целочисленные регистры
   252 000001A4 E8(00000000)                call fprintf
   253                                  
   254                                      ; Вывод текущей фигуры
   255 000001A9 488B3C25[48000000]          mov     rdi, [.pcont]
   256 000001B1 488B3425[54000000]          mov     rsi, [.FILE]
   257 000001B9 E84CFFFFFF                  call OutNumber     ; Получение периметра первой фигуры
   258                                  
   259 000001BE 59                          pop rcx
   260 000001BF 5B                          pop rbx
   261 000001C0 FFC1                        inc ecx                 ; индекс следующей фигуры
   262                                  
   263 000001C2 488B0425[48000000]          mov     rax, [.pcont]
   264 000001CA 4883C010                    add     rax, 16         ; адрес следующей фигуры
   265 000001CE 48890425[48000000]          mov     [.pcont], rax
   266 000001D6 EBAF                        jmp .loop
   267                                  .return:
   268 000001D8 C9                      leave
   269 000001D9 C3                      ret
   270                                  
