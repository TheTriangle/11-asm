     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fprintf
     4                                  
     5                                  extern ToRealComplexNumber
     6                                  extern ToRealFraction
     7                                  extern ToRealCoordinates
     8                                  
     9                                  extern COMPLEXNUMBER
    10                                  extern FRACTION
    11                                  extern COORDINATES
    12                                  
    13                                  ;----------------------------------------------
    14                                  ;// Вывод параметров прямоугольника в файл
    15                                  ;void OutRectangle(void *r, FILE *ofst) {
    16                                  ;    fprintf(ofst, "It is Rectangle: x = %d, y = %d. Perimeter = %g\n",
    17                                  ;            *((int*)r), *((int*)(r+intSize)), PerimeterRectangle(r));
    18                                  ;}
    19                                  global OutComplexNumber
    20                                  OutComplexNumber:
    21                                  section .data
    22 00000000 436F6D706C6578206E-         .outfmt db "Complex number (%d, %d) - %g",10,0
    22 00000009 756D62657220282564-
    22 00000012 2C20256429202D2025-
    22 0000001B 670A00             
    23                                  section .bss
    24 00000000 <res 00000008>              .pcomp  resq  1
    25 00000008 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    26 00000010 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
    27                                  section .text
    28 00000000 55                      push rbp
    29 00000001 4889E5                  mov rbp, rsp
    30                                  
    31                                      ; Сохранени принятых аргументов
    32 00000004 48893C25[00000000]          mov     [.pcomp], rdi          ; сохраняется адрес прямоугольника
    33 0000000C 48893425[08000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    34                                  
    35                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
    36 00000014 E8(00000000)                call    ToRealComplexNumber
    37 00000019 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    37 0000001E [10000000]         
    38                                  
    39                                      ; Вывод информации о прямоугольнике в консоль
    40                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    41                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
    42                                  ;     mov     esi, [rax]          ; x
    43                                  ;     mov     edx, [rax+4]        ; y
    44                                  ;     movsd   xmm0, [.p]
    45                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    46                                  ;     call    printf
    47                                  
    48                                      ; Вывод информации о прямоугольнике в файл
    49 00000022 488B3C25[08000000]          mov     rdi, [.FILE]
    50 0000002A 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    50 0000002C [0000000000000000] 
    51 00000034 488B0425[00000000]          mov     rax, [.pcomp]        ; адрес прямоугольника
    52 0000003C 8B10                        mov     edx, [rax]          ; x
    53 0000003E 8B4804                      mov     ecx, [rax+4]        ; y
    54 00000041 F20F100425-                 movsd   xmm0, [.p]
    54 00000046 [10000000]         
    55 0000004A B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    56 0000004F E8(00000000)                call    fprintf
    57                                  
    58 00000054 C9                      leave
    59 00000055 C3                      ret
    60                                  
    61                                  ;----------------------------------------------
    62                                  ; // Вывод параметров треугольника в файл
    63                                  ; void OutTriangle(void *t, FILE *ofst) {
    64                                  ;     fprintf(ofst, "It is Triangle: a = %d, b = %d, c = %d. Perimeter = %g\n",
    65                                  ;            *((int*)t), *((int*)(t+intSize)), *((int*)(t+2*intSize)),
    66                                  ;             PerimeterTriangle(t));
    67                                  ; }
    68                                  global OutFraction
    69                                  OutFraction:
    70                                  section .data
    71 0000001E 4672616374696F6E20-         .outfmt db "Fraction %d/%d - %g",10,0
    71 00000027 25642F2564202D2025-
    71 00000030 670A00             
    72                                  section .bss
    73 00000018 <res 00000008>              .frac  resq  1
    74 00000020 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    75 00000028 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
    76                                  section .text
    77 00000056 55                      push rbp
    78 00000057 4889E5                  mov rbp, rsp
    79                                  
    80                                      ; Сохранени принятых аргументов
    81 0000005A 48893C25[18000000]          mov     [.frac], rdi          ; сохраняется адрес прямоугольника
    82 00000062 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    83                                  
    84                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
    85 0000006A E8(00000000)                call    ToRealFraction
    86 0000006F F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    86 00000074 [28000000]         
    87                                  
    88                                      ; Вывод информации о прямоугольнике в консоль
    89                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    90                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
    91                                  ;     mov     esi, [rax]          ; x
    92                                  ;     mov     edx, [rax+4]        ; y
    93                                  ;     movsd   xmm0, [.p]
    94                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    95                                  ;     call    printf
    96                                  
    97                                      ; Вывод информации о прямоугольнике в файл
    98 00000078 488B3C25[20000000]          mov     rdi, [.FILE]
    99 00000080 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    99 00000082 [1E00000000000000] 
   100 0000008A 488B0425[18000000]          mov     rax, [.frac]        ; адрес прямоугольника
   101 00000092 8B10                        mov     edx, [rax]          ; x
   102 00000094 8B4804                      mov     ecx, [rax+4]        ; y
   103 00000097 F20F100425-                 movsd   xmm0, [.p]
   103 0000009C [28000000]         
   104 000000A0 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   105 000000A5 E8(00000000)                call    fprintf
   106                                  
   107 000000AA C9                      leave
   108 000000AB C3                      ret
   109                                  
   110                                  
   111                                  global OutCoordinates
   112                                  OutCoordinates:
   113                                  section .data
   114 00000033 436F6F72696E617465-         .outfmt db "Coorinates (%d, %d) - %g",10,0
   114 0000003C 73202825642C202564-
   114 00000045 29202D2025670A00   
   115                                  section .bss
   116 00000030 <res 00000008>              .pcoord  resq  1
   117 00000038 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
   118 00000040 <res 00000008>              .p      resq  1       ; вычисленный периметр прямоугольника
   119                                  section .text
   120 000000AC 55                      push rbp
   121 000000AD 4889E5                  mov rbp, rsp
   122                                  
   123                                      ; Сохранени принятых аргументов
   124 000000B0 48893C25[30000000]          mov     [.pcoord], rdi          ; сохраняется адрес прямоугольника
   125 000000B8 48893425[38000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   126                                  
   127                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
   128 000000C0 E8(00000000)                call    ToRealCoordinates
   129 000000C5 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
   129 000000CA [40000000]         
   130 000000CE 4883C70C                    add rdi, 12
   131 000000D2 488B3C25[40000000]          mov rdi, [.p]
   132                                      ; Вывод информации о прямоугольнике в консоль
   133                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
   134                                  ;     mov     rax, [.prect]       ; адрес прямоугольника
   135                                  ;     mov     esi, [rax]          ; x
   136                                  ;     mov     edx, [rax+4]        ; y
   137                                  ;     movsd   xmm0, [.p]
   138                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
   139                                  ;     call    printf
   140                                  
   141                                      ; Вывод информации о прямоугольнике в файл
   142 000000DA 488B3C25[38000000]          mov     rdi, [.FILE]
   143 000000E2 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
   143 000000E4 [3300000000000000] 
   144 000000EC 488B0425[30000000]          mov     rax, [.pcoord]        ; адрес прямоугольника
   145 000000F4 8B10                        mov     edx, [rax]          ; x
   146 000000F6 8B4804                      mov     ecx, [rax+4]        ; y
   147 000000F9 F20F100425-                 movsd   xmm0, [.p]
   147 000000FE [40000000]         
   148 00000102 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   149 00000107 E8(00000000)                call    fprintf
   150                                  
   151 0000010C C9                      leave
   152 0000010D C3                      ret
   153                                  ;----------------------------------------------
   154                                  ; // Вывод параметров текущей фигуры в файл
   155                                  ; void OutShape(void *s, FILE *ofst) {
   156                                  ;     int k = *((int*)s);
   157                                  ;     if(k == RECTANGLE) {
   158                                  ;         OutRectangle(s+intSize, ofst);
   159                                  ;     }
   160                                  ;     else if(k == TRIANGLE) {
   161                                  ;         OutTriangle(s+intSize, ofst);
   162                                  ;     }
   163                                  ;     else {
   164                                  ;         fprintf(ofst, "Incorrect figure!\n");
   165                                  ;     }
   166                                  ; }
   167                                  global OutNumber
   168                                  OutNumber:
   169                                  section .data
   170 0000004D 496E636F7272656374-         .erShape db "Incorrect number!",10,0
   170 00000056 206E756D626572210A-
   170 0000005F 00                 
   171                                  section .text
   172 0000010E 55                      push rbp
   173 0000010F 4889E5                  mov rbp, rsp
   174                                  
   175                                      ; В rdi адрес фигуры
   176 00000112 8B07                        mov eax, [rdi]
   177 00000114 3B0425[00000000]            cmp eax, [COMPLEXNUMBER]
   178 0000011B 7428                        je compOut
   179 0000011D 3B0425[00000000]            cmp eax, [FRACTION]
   180 00000124 742A                        je fracOut
   181 00000126 3B0425[00000000]            cmp eax, [COORDINATES]
   182 0000012D 742C                        je cordOut
   183 0000012F 48BF-                       mov rdi, .erShape
   183 00000131 [4D00000000000000] 
   184 00000139 B800000000                  mov rax, 0
   185 0000013E E8(00000000)                call fprintf
   186 00000143 EB21                        jmp     return
   187                                  compOut:
   188                                      ; Вывод прямоугольника
   189 00000145 4883C704                    add     rdi, 4
   190 00000149 E8B2FEFFFF                  call    OutComplexNumber
   191 0000014E EB16                        jmp     return
   192                                  fracOut:
   193                                      ; Вывод прямоугольника
   194 00000150 4883C704                    add     rdi, 4
   195 00000154 E8FDFEFFFF                  call    OutFraction
   196 00000159 EB0B                        jmp     return
   197                                  cordOut:
   198                                      ; Вывод прямоугольника
   199 0000015B 4883C704                    add     rdi, 4
   200 0000015F E848FFFFFF                  call    OutCoordinates
   201 00000164 EB00                        jmp     return
   202                                  return:
   203 00000166 C9                      leave
   204 00000167 C3                      ret
   205                                  
   206                                  ;----------------------------------------------
   207                                  ; // Вывод содержимого контейнера в файл
   208                                  ; void OutContainer(void *c, int len, FILE *ofst) {
   209                                  ;     void *tmp = c;
   210                                  ;     fprintf(ofst, "Container contains %d elements.\n", len);
   211                                  ;     for(int i = 0; i < len; i++) {
   212                                  ;         fprintf(ofst, "%d: ", i);
   213                                  ;         OutShape(tmp, ofst);
   214                                  ;         tmp = tmp + shapeSize;
   215                                  ;     }
   216                                  ; }
   217                                  global OutContainer
   218                                  OutContainer:
   219                                  section .data
   220 00000060 25643A2000                  numFmt  db  "%d: ",0
   221                                  section .bss
   222 00000048 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   223 00000050 <res 00000004>              .len    resd    1   ; адрес для сохранения числа введенных элементов
   224 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   225                                  section .text
   226 00000168 55                      push rbp
   227 00000169 4889E5                  mov rbp, rsp
   228                                  
   229 0000016C 48893C25[48000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   230 00000174 893425[50000000]            mov [.len],   esi     ; сохраняется число элементов
   231 0000017B 48891425[54000000]          mov [.FILE],  rdx    ; сохраняется указатель на файл
   232                                  
   233                                      ; В rdi адрес начала контейнера
   234 00000183 4889F3                      mov rbx, rsi            ; число фигур
   235 00000186 31C9                        xor ecx, ecx            ; счетчик фигур = 0
   236 00000188 4889D6                      mov rsi, rdx            ; перенос указателя на файл
   237                                  .loop:
   238 0000018B 39D9                        cmp ecx, ebx            ; проверка на окончание цикла
   239 0000018D 7D4D                        jge .return             ; Перебрали все фигуры
   240                                  
   241 0000018F 53                          push rbx
   242 00000190 51                          push rcx
   243                                  
   244                                      ; Вывод номера фигуры
   245 00000191 488B3C25[54000000]          mov     rdi, [.FILE]    ; текущий указатель на файл
   246 00000199 48BE-                       mov     rsi, numFmt     ; формат для вывода фигуры
   246 0000019B [6000000000000000] 
   247 000001A3 89CA                        mov     edx, ecx        ; индекс текущей фигуры
   248 000001A5 4831C0                      xor     rax, rax,       ; только целочисленные регистры
   249 000001A8 E8(00000000)                call fprintf
   250                                  
   251                                      ; Вывод текущей фигуры
   252 000001AD 488B3C25[48000000]          mov     rdi, [.pcont]
   253 000001B5 488B3425[54000000]          mov     rsi, [.FILE]
   254 000001BD E84CFFFFFF                  call OutNumber     ; Получение периметра первой фигуры
   255                                  
   256 000001C2 59                          pop rcx
   257 000001C3 5B                          pop rbx
   258 000001C4 FFC1                        inc ecx                 ; индекс следующей фигуры
   259                                  
   260 000001C6 488B0425[48000000]          mov     rax, [.pcont]
   261 000001CE 4883C010                    add     rax, 16         ; адрес следующей фигуры
   262 000001D2 48890425[48000000]          mov     [.pcont], rax
   263 000001DA EBAF                        jmp .loop
   264                                  .return:
   265 000001DC C9                      leave
   266 000001DD C3                      ret
   267                                  
